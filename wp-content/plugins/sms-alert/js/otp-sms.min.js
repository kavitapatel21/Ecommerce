var interval;
jQuery(document).on("input", ".otp_input",function(){
	enableValidateBtn(this);
});

jQuery(document).on('keypress', '.otp_input,.otp-number', function (e) {
    if (e.which == 13) e.preventDefault();
	var maxlength = jQuery(this).attr("data-max");
	
	if(jQuery(this).val().length==maxlength)
	{
		if(event.which){
			event.preventDefault();
		}
	}
});


if(
	(typeof sa_otp_settings  != 'undefined' && sa_otp_settings['is_checkout']) && 
	((typeof sa_otp_settings !=  'undefined' && sa_otp_settings['login_with_otp']) ||
	(typeof sa_otp_settings !=  'undefined' && sa_otp_settings['buyer_login_otp'])	
	)
)
{
	jQuery(".showlogin").parents(".woocommerce-info").hide();
	var content 	= jQuery(".showlogin").parents(".woocommerce-info").clone();
	
	var child_div 	= jQuery(".showlogin").parents(".woocommerce-info").after(content);

	child_div.show();
	child_div.find('.showlogin').addClass("sa-showlogin").removeClass("showlogin");

	jQuery(document).on("click",".sa-showlogin",function(){
		if(sa_otp_settings['hide_default_login_form'] == 'on')
		{
			jQuery(".sa-lwo-form").toggle();
		}
		else
		{			
			if(jQuery(this).hasClass("lwo-opened"))
			{
				jQuery(".sa-lwo-form").hide();
				jQuery(".woocommerce-form-login").hide();
				jQuery(this).removeClass("lwo-opened");
			}
			else
			{
				jQuery(".woocommerce-form-login").not('.sa-lwo-form').toggle();
				jQuery(this).addClass("lwo-opened");
			}
		}
	});
}

jQuery(document).on("click",".sa_default_login_form,.sa_default_signup_form",function(){
	var parent_cls = jQuery(this).attr("data-parentform");
	if(jQuery(this).parents('.smsalert-modal').length>0)
	{
		var id = jQuery(this).parents('.smsalert-modal').attr('id');
		jQuery("#"+id+" ."+parent_cls).fadeIn(1000,'linear');
	}
	else{
		jQuery("form."+parent_cls).fadeIn(1000,'linear');
	}
	jQuery(this).parents("form").attr("style","display:none!important");
	jQuery(this).parents("form").find(".phone-valid").val("");
});	

jQuery(document).on("click", ".sa_myaccount_btn",function(e){
	var parentForm =  jQuery(this).parents("form");
	if(parentForm.parents('.um-login').length > 0)
	{
		parentForm.addClass('login');
	}
	if(parentForm.hasClass('login'))
	{
		jQuery(".loginwithotp").parents("div").find('.sa_default_login_form').trigger("click");
		parentForm.after(jQuery(".loginwithotp").detach());
		parentForm.parents("div").find('.loginwithotp').not('.loginwithotp:first').remove();
	}
    else if(parentForm.hasClass('register'))
	{
		parentForm.after(jQuery(".signupwithmobile").detach());
	}
	parentForm.attr("style", "display: none !important");
	parentForm.parent().find(".sa-lwo-form").fadeIn(200,'linear',function(){
		var mob_field = jQuery(this).find('.phone-valid');		
		jQuery('html').animate({scrollTop: mob_field.offset().top-100}, 500, function() {			
		    mob_field.focus();	
		});	
	});
	parentForm.parent().find(".sa-lwo-form").addClass("lwo-opened");
	
	if(sa_otp_settings['hide_default_login_form'] == 'on')
	{
		jQuery(".sa-showlogin").trigger("click");
	}
});

jQuery(document).on("click", ".close",function(){
	clearInterval(interval);
	jQuery(".blockUI").hide();
	var modal_style = jQuery(this).parents().find('.smsalertModal').attr('data-modal-close');
	jQuery(this).parents().find('.smsalertModal').addClass(modal_style+'Out');
    jQuery(this).parents(".smsalertModal").not('.smsalert-modal').hide('slow');
	setTimeout(function() {
		jQuery('.smsalertModal').removeClass(modal_style+'Out');
	}, 500);
});

let digitGroup = function(ele){
 	ele.value = ele.value.replace(/[^0-9]/g,'');
	var cur_class = ele.className;
	var maxlength = jQuery('.'+cur_class).attr("data-max");
	var next_input = ele.id.slice(6);
	if(ele.value.length > maxlength)
	{
		var cur_val = ele.value.slice(0, 1);
		jQuery("."+cur_class).val(cur_val);
	}
}

let tabChange = function(val,modal_id){
	var modal_form_class = modal_id.parentElement.parentElement.parentElement.parentElement.getAttributeNode("data-form-id").value;

	let ele = '';
	if( modal_form_class == "" ){
		ele = document.querySelectorAll('.digit-group input');
	} else {
		ele = document.querySelectorAll('.'+modal_form_class+' .digit-group input');
	}
	
    if(ele[val-1].value != ''){
      ele[val].focus();
    }else if(ele[val-1].value == '' && event.currentTarget.id != 'digit-1'){
      ele[val-2].focus();
    } 	
}


jQuery(document).on("keyup",".smsalertModal .otp-number",function(e) {
	var otp_length 	= jQuery('#smsalert_customer_validation_otp_token').attr('data-max');
	var txtData 	= [];
	var parent 		= jQuery(this).parents(".smsalertModal");
	parent.find(".otp-number").each(function() {
		var otp_number = jQuery(this).val();
		txtData.push(otp_number);
	});
	parent.find(".otp_input").val(txtData.join(""));
	enableValidateBtn(parent.find(".otp_input"),otp_length);
	e.preventDefault();
	if(e.key === "Delete" && e.target.selectionStart==0) {
	var item 		= jQuery(this);	
	item.val(item.next('.otp-number').val());
	item.nextAll(".otp-number").each(function() {
		item[0].setSelectionRange(0,0);
		jQuery(this).val(jQuery(this).next('.otp-number').val());
	  });
	  e.preventDefault();
    }
	if(e.key === "ArrowLeft" || e.key === "Backspace") {
		jQuery(this).prev('.otp-number').focus();
    }
	if(e.key === "ArrowRight") {
	  jQuery(this).next('.otp-number').focus();
    } 
});


jQuery(window).ready(function(){
	jQuery(".sa_myaccount_btn").closest("form").find('#rememberme').closest('label').each(function () {
		var form = jQuery(this).closest('form');
		form.find('.woocommerce-LostPassword').prepend(jQuery(this));
	});
if(sa_otp_settings['hide_default_login_form'] == 'on')
{
	jQuery(".sa_myaccount_btn[name=sa_myaccount_btn_login]").trigger("click");
	jQuery(".sa_default_login_form").hide();
	jQuery(".sa_loginwithotp-form").show();
}	
var otp_field = jQuery(".otp-number");
otp_field.on({
  paste(ev) { 
    var modal_cls = ev.target.parentElement.parentElement.parentElement.parentElement.getAttributeNode("data-form-id").value;
	otp_field = jQuery("."+modal_cls+" .otp-number");
	var maxlength = jQuery("."+modal_cls+" .otp_input").attr("data-max");
    var clip = ev.originalEvent.clipboardData.getData('text').trim();
    var sc = [...clip];
     otp_field.val(i => sc[i]).eq(maxlength-1).focus();
    jQuery(".otp-number").trigger('keyup');	 
	return ev.preventDefault();
  }
});
});

function getCountryByCode(code) {
	return window.intlTelInputGlobals.getCountryData().filter(
	function(data){ return (data.dialCode == code) ? data.iso2 : ''; }
	);
}

function enableValidateBtn(obj,otp_length=0)
{
	if(jQuery(obj).val().match(/^\d{4,8}$/)) {
		jQuery("#sa_verify_otp,obj").removeAttr("style");
		jQuery("#sa_verify_otp,obj").removeAttr("disabled");	
	}
	else
	{
		jQuery("#sa_verify_otp,obj").css({"color":"grey","pointer-events":"none"});
	}
}

function saResendOTP(obj)
{
	jQuery(obj).text('re-sending..');
	jQuery(".sa-otp-initiated").trigger("click");
	return false;
}

function sa_otp_timer(obj,otp_timer=15)
{
	var timer = function(secs){
		var sec_num = parseInt(secs, 10)    
		var hours   = Math.floor(sec_num / 3600) % 24
		var minutes = Math.floor(sec_num / 60) % 60
		var seconds = sec_num % 60    
		hours = hours < 10 ? "0" + hours : hours;
		minutes = minutes < 10 ? "0" + minutes : minutes;
		seconds = seconds < 10 ? "0" + seconds : seconds;
		return [hours,minutes,seconds].join(":")
	};
	obj.find(".sa_timer").show().html(timer(otp_timer)+" sec");;
	obj.find(".sa_forgot").hide();
	obj.find(".sa_resend_btn").text("Resend");
	var counter = otp_timer;
	 interval = setInterval(function() {
		counter--;
		var places = (counter < 10 ? "0" : "");
		obj.find(".sa_timer").html(timer(counter)+" sec");
		if (counter == 0) 
		{
			counterRunning=false;
			obj.find(".sa_timer").hide();
			obj.find(".sa_forgot").show(); // 23/06												   
			var cssString = "pointer-events: auto; cursor: pointer; opacity: 1; float:right"; 
			obj.find(".sa_resend_btn").attr("style",cssString);
			clearInterval(interval);
			}
		else
		{
			var cssString = "pointer-events: none; cursor: default; opacity: 1; float:right";
			obj.find(".sa_resend_btn").attr("style",cssString);
		}
	}, 1000);
}

function saInitOTPProcess(obj,action_url, data_obj,otp_resend_timer=15,success_cb=null,failure_cb=null,submit_selector=null)
{
	var waiting_txt 	= (typeof sa_notices !=  'undefined' && sa_notices['waiting_txt']) ? sa_notices['waiting_txt'] : "Please Wait...";			
	var cur_btn 	   	= jQuery(obj);
	var prev_btn_text 	= cur_btn.val();
	
	var wpml_lang 		= (typeof smsalert_wpml !=  'undefined' && smsalert_wpml['lang']) ? smsalert_wpml['lang'] : "";
	if(cur_btn.is("input")){
		cur_btn.val(waiting_txt).attr("disabled",true);
		
	}else{
		cur_btn.addClass('button--loading').attr("disabled",true);
	}
	jQuery('.sa-otp-btn-init').removeClass('sa-otp-initiated');
	$sa = jQuery;
	$sa.ajax({
		url:action_url+"&lang="+wpml_lang,
		type:"POST",
		data:data_obj,
		cache: false,
		crossDomain:!0,
		dataType:"json",
		success:function(o){
		   if("failure"==o.result)
		   {
			showError(o,cur_btn,failure_cb,prev_btn_text);
			return false;
		   }
		   showModal(o,cur_btn,submit_selector,prev_btn_text,success_cb,otp_resend_timer);
		},
		error:function(o,e,m)
		{
			showError(o,cur_btn,failure_cb,prev_btn_text);
		}
	});		   
	return false;
}

function showModal(o,cur_btn,submit_selector,prev_btn_text,success_cb,otp_resend_timer)
{
	jQuery('[tabindex="-1"]').removeAttr('tabindex');
	var currentModel 	= jQuery(".modal.smsalertModal"); 
	("success"==o.result)?(
		(cur_btn.is("input") ? cur_btn.val(prev_btn_text).attr("disabled",false) : cur_btn.removeClass('button--loading').attr("disabled",false)),
		cur_btn.addClass('sa-otp-initiated'),
		currentModel.find(".sa-message").empty().removeClass("woocommerce-error").append(o.message).addClass("woocommerce-message"),
		currentModel.show(),
		currentModel.find(".otp_input,.otp-number").val(""),
		currentModel.find(".otp_input,.otp-number").not(".hide").first().val("").focus(),
		jQuery( "#sa_verify_otp" ).on( "click",{btn_class: submit_selector}, validateOtp ),
		currentModel.find(".smsalert_validate_field").show(),
		sa_otp_timer(currentModel,otp_resend_timer),
		((typeof success_cb == "function") ? success_cb(o) : "" )
		):
		(
		currentModel.find(".smsalert_validate_field").hide(),
		currentModel.find(".sa-message").empty().removeClass("woocommerce-message").append(o.message).addClass("woocommerce-error"),
		currentModel.show(),
		(cur_btn.is("input") ? cur_btn.val(prev_btn_text).attr("disabled",false) : cur_btn.removeClass('button--loading').attr("disabled",false))
		);
	return false;
}

function showError(o,cur_btn,failure_cb,prev_btn_text)
{
	cur_btn.val(prev_btn_text).attr("disabled",false);
	cur_btn.removeClass('check').attr("disabled",false);
	cur_btn.removeClass('button--loading').attr("disabled",false);
	(typeof failure_cb == "function") ? failure_cb(o) : "" ;
}

function sa_validateOTP(obj,action_url,data_obj,callback)
{
	$sa  =jQuery;
	var current_btn = $sa('#sa_verify_otp');
	var waiting_txt 	= (typeof sa_notices !=  'undefined' && sa_notices['waiting_txt']) ? sa_notices['waiting_txt'] : "Please wait...";	
	var current_modal = $sa(".modal.smsalertModal");	
	var wpml_lang 		= (typeof smsalert_wpml !=  'undefined' && smsalert_wpml['lang']) ? smsalert_wpml['lang'] : "";	

	$sa.ajax({
		url:action_url+"&lang="+wpml_lang,
		type:"POST",
		data:data_obj,
		crossDomain:!0,
		dataType:"json",
		beforeSend: function( xhr ) {
   			current_modal.find(".sa-message").empty().addClass("woocommerce-message").text(waiting_txt);
   			if(current_btn.is("input")){
				current_btn.val(waiting_txt).attr("disabled",true);
			
			}else{
				current_btn.addClass('button--loading').attr("disabled",true).text(" ").css("height","4pc");
			}
		},
		success:function(o){
		  otpSuceess(o,current_btn,callback);
		},
		error:function(o,e,m)
		{
			alert("error found here");
		}
	});
}

function otpSuceess(o,current_btn,callback)
{
	var current_modal = $sa(".modal.smsalertModal");
	("success"==o.result && o.message=="OTP Validated Successfully.")?
	(
		current_btn.removeClass("button--loading"),
		current_btn.text("Validate OTP"),
		current_modal.hide(),
		((typeof callback == "function") ? callback() : "" )
	):
	(
	current_btn.attr("disabled",false),
	current_btn.removeClass("button--loading"),
	current_btn.text("Validate OTP"),
	current_modal.find(".sa-message").show().empty().addClass("woocommerce-error").append(o.message).removeClass("woocommerce-message"),
	current_modal.find(".otp_input").focus());
}

function add_smsalert_button(submit_selector,phone_selector,unique_id,button_text='')
{
	if(!jQuery(submit_selector).hasClass("sa-default-btn-hide"))
	{
	jQuery(phone_selector).parents("form").addClass("sas-form");
	var button = jQuery(submit_selector);
	jQuery(submit_selector).addClass("sa-default-btn-hide");
	jQuery(button.clone()).insertAfter(submit_selector).addClass("sa-otp-btn-init smsalert_otp_btn_submit");
	jQuery(submit_selector+".sa-otp-btn-init").attr("id","sa_verify_"+unique_id).attr("name","sa_verify_"+unique_id);
	jQuery(".sa-otp-btn-init").removeClass("sa-default-btn-hide");
	jQuery(phone_selector).addClass("phone-valid");
	
	if(jQuery(submit_selector).is("button")){
		var text = (button_text!='')?button_text:jQuery(submit_selector+".sa-default-btn-hide").text();
		jQuery("#sa_verify_"+unique_id).html("<span class=button__text>"+ text+"</span>");
	}
	}
}
function send_otp(obj,submit_selector,phone_selector,username_selector,password_selector)
{
	jQuery(obj).parents(".smsalertModal").hide();
    var country_enable = sa_otp_settings['show_countrycode'];
    var site_url = sa_otp_settings['site_url'];
    var otp_resend_timer = sa_otp_settings['otp_time'];
	if ( "on" !== country_enable ) {
		var e = jQuery(obj).parents("form").find(phone_selector).val();
	} else {
		var e = jQuery(obj).parents("form").find(phone_selector).intlTelInput("getNumber");
	}
	var u 	= jQuery(obj).parents("form").find(username_selector).val();
	var p			= jQuery(obj).parents("form").find(password_selector).val();
	if(typeof u !== "undefined" && typeof p !== "undefined")
	{
		var data 	= {username:u,password:p};
	}
	else
	{
		var data 	= {user_phone:e};
	}
	jQuery(obj).parents("form").find("[aria-required=true], [required],.ff-el-is-required,.validate-required").not(".otp_input").each(function(){
		jQuery(this).removeClass("sa_field_error");
		if(jQuery(this).is(":hidden")){
			return true;
		}
		
		if((jQuery(this).attr("aria-required") || jQuery(this).attr("required")) && jQuery(this).val() === ""){
			jQuery(this).addClass("sa_field_error");
		}

        if(jQuery(this).hasClass("ff-el-is-required") && jQuery(this).next().find("input,select").val() === ""){
			jQuery(this).addClass("sa_field_error");
		}
        if(jQuery(this).hasClass("validate-required") && jQuery(this).find("input,select").val() === ""){
			jQuery(this).addClass("sa_field_error");
		}  		
		
		if(!jQuery(this).hasClass("sa_field_error") && jQuery(this).attr("minlength")){

			var char_length = jQuery(this).val().length;

			if(char_length < jQuery(this).attr("minlength")){
				jQuery(this).addClass("sa_field_error");
			}
		}

		if(!jQuery(this).hasClass("sa_field_error") && jQuery(this).attr("maxlength")){

			var char_length = jQuery(this).val().length;

			if(char_length > jQuery(this).attr("maxlength")){
				jQuery(this).addClass("sa_field_error");
			}
		}
	});
	if(jQuery(obj).parents("form").find(".sa_field_error").length === 0)
	{
		if(username_selector !="" && password_selector !="")
		{
		   var action_url 	= site_url+"/?option=smsalert_ajax_login_popup";
		}
		else if(jQuery(obj).parents("form").hasClass("sa_loginwithotp-form")){
			data = jQuery(obj).parents("form").serialize();
			action_url 	= site_url+"/?option=smsalert_ajax_login_with_otp";
		}
		else if(jQuery(obj).parents("form").hasClass("sa-signupwithotp-form")){
			data = jQuery(obj).parents("form").serialize();
			action_url 	= site_url+"/?option=smsalert-registration-with-mobile";
		}
		else if(jQuery(obj).parents("form").hasClass("woocommerce-checkout")){
			var cartflow_param = '';
			if(typeof cartflows  != 'undefined')
			{
				cartflow_param = '&wcf_checkout_id='+cartflows['control_step'];
			}
			data = jQuery(obj).parents("form").serialize()+"&checkout=Checkout";
			action_url 	= site_url+"/?option=smsalert-woocommerce-checkout-process&wc-ajax=checkout"+cartflow_param;
		}
		else if(jQuery(obj).parents("form").hasClass("woocommerce-post-checkout-form")){
			action_url 	= site_url+"/?option=smsalert-woocommerce-post-checkout";
		}
		else if(jQuery(obj).parents("form").hasClass("register") || jQuery(obj).parents("form").hasClass("pie_register_reg_form") || jQuery(obj).parents("form").hasClass("uwp-registration-form") || jQuery(obj).parents().find(".um-register").length > 0){
			data = jQuery(obj).parents("form").serialize()+"&register=Register";
			action_url 	= site_url+"/?option=smsalert_register_with_otp";
		}
		else{
			action_url 	= site_url+"/?option=smsalert-shortcode-ajax-verify";
		}
		saInitOTPProcess(obj,action_url, data,otp_resend_timer,function(resp){},function(){
	jQuery(obj).parents("form").find(".sa-default-btn-hide").not(".sa-otp-btn-init").trigger("click")},submit_selector);
		return false;
	}
	else
	{
		jQuery(obj).parents("form").find(".sa-default-btn-hide").not(".sa-otp-btn-init").trigger("click");
		setTimeout(function() {jQuery(".wc-block-components-checkout-place-order-button").not(".sa-otp-btn-init").addClass("sa-default-btn-hide")}, 10);
		return false;
	}
}
function validateOtp(event)
{
	var site_url = sa_otp_settings['site_url'];
	var submit_selector = event.data.btn_class;
	var c_form 	= jQuery(".sa-otp-initiated").parents("form");
	var otp = jQuery("#smsalert_customer_validation_otp_token").val();
	var action_url 		= site_url+"/?option=smsalert-validate-otp-form";
	var data 			= c_form.serialize()+"&otp_type=phone&from_both=&smsalert_customer_validation_otp_token="+otp;
	sa_validateOTP(submit_selector,action_url,data,function(){
		jQuery(submit_selector).hasClass("sa-default-btn-hide")?c_form.find(".sa-default-btn-hide").not(".sa-otp-btn-init").trigger("click"):jQuery("#order_verify").val(otp);
		
	});
}